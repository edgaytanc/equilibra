{% extends "base.html" %}

{% block title %}Chat con Kai{% endblock %}

{% block content %}
<style>
    /* Estilos personalizados para la ventana y las burbujas de chat */
    .chat-card {
        height: 75vh;
        display: flex;
        flex-direction: column;
    }

    .chat-window {
        flex-grow: 1;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 15px;
    }

    .message {
        padding: 10px 15px;
        border-radius: 18px;
        max-width: 80%;
        line-height: 1.4;
    }

    .message.user {
        background-color: #0d6efd; /* Color primario de Bootstrap */
        color: white;
        align-self: flex-end;
    }

    .message.bot {
        background-color: #e9ecef; /* Color de fondo sutil de Bootstrap */
        color: black;
        align-self: flex-start;
    }
</style>

<div class="row justify-content-center">
    <div class="col-12 col-md-10 col-lg-8">
        <div class="card shadow-lg chat-card">
            
            <div class="card-header bg-dark text-white text-center">
                <h5 class="my-1">Conversando con ELENA</h5>
                <small class="text-white-50">Puntuación de Ansiedad (NEG): <span id="anxiety-score">0.00</span></small>
            </div>
            
            <div class="card-body p-4 chat-window" id="chat-window">
                {% if not messages %}
                    <div class="message bot">
                        Hola, soy Kai. Estoy aquí para escucharte. ¿Cómo te sientes hoy?
                    </div>
                {% else %}
                    {% for msg in messages %}
                        <div class="message {{ msg.sender }}">
                            {{ msg.content | safe }}
                        </div>
                    {% endfor %}
                {% endif %}
            </div>
            
            <div class="card-footer p-3 bg-light">
                <form id="chat-form">
                    <div class="input-group">
                        <input type="text" id="message-input" class="form-control form-control-lg" placeholder="Escribe tu mensaje aquí..." autocomplete="off" autofocus>
                        <button class="btn btn-dark" type="submit" id="send-button">
                            <i class="bi bi-send-fill"></i>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    // El script de JavaScript no necesita cambios, 
    // pero lo incluimos aquí para que el archivo esté completo.
    
    const chatForm = document.getElementById('chat-form');
    const messageInput = document.getElementById('message-input');
    const chatWindow = document.getElementById('chat-window');
    const anxietyScoreSpan = document.getElementById('anxiety-score');

    // Auto-scroll al cargar
    window.onload = () => {
        chatWindow.scrollTop = chatWindow.scrollHeight;
    };

    chatForm.addEventListener('submit', async (event) => {
        event.preventDefault();
        const userMessage = messageInput.value.trim();
        if (!userMessage) return;

        appendMessage(userMessage, 'user');
        messageInput.value = '';
        messageInput.focus();

        try {
            const response = await fetch("{{ url_for('main.chat') }}", {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: userMessage })
            });
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();
            
            appendMessage(data.bot_response, 'bot');
            anxietyScoreSpan.textContent = data.anxiety_score;

        } catch (error) {
            console.error('Error al enviar el mensaje:', error);
            appendMessage('Lo siento, no pude conectar con el servidor. Por favor, inténtalo de nuevo más tarde.', 'bot');
        }
    });

    function appendMessage(message, sender) {
        const messageElement = document.createElement('div');
        messageElement.classList.add('message', sender);
        messageElement.innerHTML = message; // Usamos innerHTML para renderizar posibles saltos de línea o formato simple
        chatWindow.appendChild(messageElement);
        chatWindow.scrollTop = chatWindow.scrollHeight;
        return messageElement;
    }
</script>
{% endblock %}